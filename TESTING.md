# 测试多用户登录和群组功能

## 最新更新

### 已修复的问题
1. **连接超时问题**：移除了不必要的 ready channel 同步机制，改用阻塞发送确保关键消息不丢失
2. **退出重连问题**：完善了状态管理，确保退出后所有状态正确重置
3. **添加了 10 秒超时保护**：防止永久"连接中"状态

### 新增功能
✅ **群组聊天功能**
- 选择多个用户（至少2人）可创建群组
- 支持群组消息发送
- 群组信息显示
- 群组和私聊自由切换

## 解决方案
1. **简化连接流程**：WritePump 异步启动，使用带缓冲的通道和阻塞发送确保消息可靠性
2. **完善状态管理**：在登出、连接关闭、连接错误时正确重置所有状态
3. **添加超时保护**：10秒后自动重置连接状态

## 测试步骤

### 1. 启动后端服务器
后端服务器已在运行，监听端口 9090。

### 2. 启动前端服务器
```bash
cd /Users/bytedance/network_lab4/frontend
npm run dev
```

### 3. 测试多用户登录

#### 方法1：使用多个浏览器窗口
1. 打开第一个浏览器窗口，访问 http://localhost:5173
2. 输入昵称 "用户A"，点击登录
3. 打开第二个浏览器窗口（可以使用隐私/无痕模式），访问 http://localhost:5173
4. 输入昵称 "用户B"，点击登录
5. 打开第三个浏览器窗口，访问 http://localhost:5173
6. 输入昵称 "用户C"，点击登录

#### 方法2：使用不同浏览器
1. 在 Chrome 中打开，昵称 "用户A"
2. 在 Firefox 中打开，昵称 "用户B"  
3. 在 Safari 中打开，昵称 "用户C"

### 4. 验证功能

在每个登录的用户窗口中，你应该能看到：

✅ **用户列表正确显示**
- 每个用户应该能看到其他在线用户
- 用户A 能看到：用户B、用户C
- 用户B 能看到：用户A、用户C
- 用户C 能看到：用户A、用户B
- 每个用户**不应该**看到自己在用户列表中

✅ **上线通知**
- 当新用户登录时，已登录的用户会收到上线通知

✅ **消息发送**
- 选择一个或多个用户
- 发送文本消息
- 对方应该能收到消息

✅ **图片和文件发送**
- 点击"图片"或"文件"按钮上传
- 对方应该能收到并下载

### 5. 查看调试日志

打开浏览器开发者工具（F12），在 Console 标签中可以看到：
- "收到用户列表: [...]" - 显示完整的用户列表
- "当前用户ID: xxx" - 显示当前用户的ID
- "过滤后的在线用户: [...]" - 显示过滤后的用户列表

后端终端会显示：
- 每个用户的登录请求
- 用户注册成功信息
- 登录响应发送确认

## 预期结果

✅ 多个用户可以同时登录
✅ 每个用户能看到其他在线用户列表
✅ 用户列表自动更新（新用户加入或离开时）
✅ 用户可以互相发送消息
✅ 消息正确显示发送者昵称

## 故障排除

如果仍然无法看到其他用户：

1. **检查浏览器控制台**
   - 打开开发者工具（F12）
   - 查看 Console 中的日志
   - 确认是否收到用户列表消息

2. **检查后端日志**
   - 确认后端收到登录请求
   - 确认用户注册成功
   - 确认发送了用户列表广播

3. **清除浏览器缓存**
   - 按 Ctrl+Shift+R (Windows/Linux) 或 Cmd+Shift+R (Mac) 强制刷新
   - 或者使用无痕/隐私模式

4. **重启服务**
   - 停止前端服务器（Ctrl+C）
   - 停止后端服务器（Ctrl+C）
   - 重新启动两个服务器
