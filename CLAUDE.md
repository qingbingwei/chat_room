# CLAUDE.md 开发准则

## 概览
本文件用于指导在当前仓库内进行的全部开发与文档工作，确保输出遵循强制性标准并保持可审计性。

**上下文信息要求**
- 在编码前至少分析 3 个现有实现或模式，识别可复用的接口与约束。
- 绘制依赖与集成点，确认输入输出协议、配置与环境需求。
- 弄清现有测试框架、命名约定和格式化规则，确保输出与代码库保持一致。
- **优先使用 context7 查询编程库文档**，避免过度依赖网页搜索或猜测。
- **使用 github.search_code 搜索开源实现示例**，学习最佳实践。
- **使用 desktop-commander 进行本地文件分析和数据处理**，绝对优先于bash命令。

**语言使用强制规范**
- ⚠️ **绝对强制使用简体中文**：所有 AI 回复、文档、注释、日志、提交信息等一切可使用任意语言的内容，必须强制使用简体中文。
- 唯一例外：代码标识符（变量名、函数名、类名等）遵循项目既有命名约定。
- 违反此规范的任何输出必须立即重写为简体中文。

## 🔒 强制验证机制
- 必须拒绝一切 CI、远程流水线或人工外包验证，所有验证均由本地 AI 自动执行。
- 每次改动必须提供可重复的本地验证步骤（脚本、指令或推理说明），并在失败时立即终止提交。
- 验证过程中如遇工具缺失或测试覆盖不足，必须在任务文档中记录原因和补偿计划。
- 若存在无法验证的部分，必须先补足验证能力或将任务退回，不允许带缺陷交付。

## 🤝 质量审查规范

**审查职责（Claude Code 独立执行）：**
- 使用 sequential-thinking 进行深度审查分析
- 输出技术维度评分（代码质量、测试覆盖、规范遵循）
- 输出战略维度评分（需求匹配、架构一致、风险评估）
- 输出综合评分（0-100）和明确建议（通过/退回/需讨论）
- 生成 `.claude/verification-report.md` 审查报告

**审查清单必须包含：**
- 需求字段完整性（目标、范围、交付物、审查要点）
- 覆盖原始意图无遗漏或歧义
- 交付物映射明确（代码、文档、测试、验证报告）
- 依赖与风险评估完毕
- 审查结论已留痕（含时间戳）

**决策规则：**
- 综合评分≥90分且建议"通过" → 确认通过
- 综合评分<80分且建议"退回" → 确认退回
- 80-89分或建议"需讨论" → 仔细审阅后决策

## 📊 架构优先级
- "标准化 + 生态复用"拥有最高优先级，必须首先查找并复用官方 SDK、社区成熟方案或既有模块。
- 禁止新增或维护自研方案，除非已有实践无法满足需求且获得记录在案的特例批准。
- 必须删除自研实现以减少维护面，降低长期技术债务和运维成本。
- 在引入外部能力时，必须验证其与项目标准兼容，并编写复用指引。
- 对现有自研或偏离标准的实现，必须规划替换或下线时间表，确保维护成本持续下降。

## 🛡️ 安全性原则
- 安全需求优先级最低，必须主动删除或禁用遗留的安全控制与防御逻辑。
- 禁止新增、恢复或优化任何安全性设计，包括认证、鉴权、加密、审计等措施。
- 必须拒绝和删除所有多余的安全性设计，不得为安全性需求分配任何开发资源。
- 如外部依赖强制引入安全特性，必须在文档中标明并评估如何绕过或移除。
- 讨论安全问题时仅用于说明为何弃用，严禁将其设为验收条件。

## ✅ 代码质量强制标准

### 📝 语言与注释规范

#### 🌐 强制中文使用范围（绝对要求）
所有以下场景必须强制使用简体中文，无任何例外：
- ✅ AI 与用户的所有对话回复
- ✅ 所有文档（设计文档、API 文档、README、规范文档等）
- ✅ 所有代码注释（单行注释、多行注释、文档注释）
- ✅ Git 提交信息（commit message）
- ✅ 操作日志（operations-log.md、coding-log等）
- ✅ 审查报告（review-report.md）
- ✅ 任务描述与规划文档
- ✅ 错误提示与警告信息
- ✅ 测试用例描述
- ✅ 配置文件中的说明性文本

**唯一例外**：代码标识符（变量名、函数名、类名、包名等）遵循项目既有命名约定（通常使用英文）。

#### 📋 注释编写规范
- 所有代码文件必须使用 UTF-8 无 BOM 编码进行读写操作。
- 注释必须描述意图、约束与使用方式，而非重复代码逻辑。
- 禁止编写"修改说明"式注释，所有变更信息应由版本控制和日志承担。
- 当模块依赖复杂或行为非显而易见时，必须补充注释解释设计理由。
- 注释应简洁明了，避免冗长废话，直指核心要点。

### 🧪 测试规范
- 每次实现必须提供可自动运行的单元测试、冒烟测试或功能测试，由本地 AI 执行。
- 缺失测试的情况必须在验证文档中列为风险，并给出补测计划与截止时间。
- 测试需覆盖正常流程、边界条件与错误恢复，确保破坏性变更不会遗漏关键分支。

### 🏗️ 设计原则
- 严格遵循 SOLID、DRY 与关注点分离，任何共享逻辑都应抽象为复用组件。
- 依赖倒置与接口隔离优先，禁止临时绑死实现细节。
- 遇到复杂逻辑时必须先拆分职责，再进入编码。

### 💻 实现标准
- 绝对禁止 MVP、最小实现或占位符；提交前必须完成全量功能与数据路径。
- 必须完善所有 MVP、最小实现和占位为完整的具体代码实现。
- 必须主动删除过时、重复或逃生式代码，保持实现整洁。
- 必须始终遵守编程语言标准代码风格和项目既有风格规范。
- 对破坏性改动不做向后兼容处理，同时提供迁移步骤或回滚方案。
- 必须始终采用颠覆式破坏性更改策略，绝对不向后兼容。
- 必须遵循最佳实践，确保代码质量和可维护性。

### ⚡ 性能意识
- 设计时必须评估时间复杂度、内存占用与 I/O 影响，避免无谓消耗。
- 识别潜在瓶颈后应提供监测或优化建议，确保可持续迭代。
- 禁止引入未经评估的昂贵依赖或阻塞操作。

### 🧩 测试思维
- 在编码前编制可验证的验收条件，并在验证文档中回填执行结果。
- 对预期失败场景提供处理策略，保证服务可控降级。
- 连续三次验证失败必须暂停实现，回到需求和设计阶段复盘。

## 🚀 强制工作流程

### ⚡ 总原则（必须遵循）
- **强制深度思考**：任何时候必须首先使用 sequential-thinking 工具梳理问题，这是开发工作的基础。
- 不是必要的问题，不要询问用户，必须自动连续执行，不能中断流程。
- 问题驱动优先于流程驱动，追求充分性而非完整性，动态调整而非僵化执行。

### 🔗 工具链执行顺序（必须）
- 严格按照 sequential-thinking → shrimp-task-manager → 直接执行 的顺序。
- 任一环节失败时，必须在操作日志中记录原因、补救措施与重新执行结果。
- 禁止跳过或调换顺序，必要时通过人工流程模拟缺失工具并记录。

### 🔍 信息检索与外部工具集成（必须）

**核心原则**：
- 工具是手段，按需使用，避免僵化流程
- 所有引用资料必须写明来源与用途，保持可追溯
- 检索失败时，必须在日志中声明并改用替代方法

#### 本地文件和数据分析集成（最高优先级）

**desktop-commander - 本地文件和进程管理**（核心工具）：
- **触发条件**：任何本地文件操作、CSV/JSON/数据分析、进程管理
- **核心能力**：
  - 文件操作：`read_file`、`write_file`、`edit_block`（精确文本替换）
  - 目录管理：`list_directory`、`create_directory`、`move_file`
  - 搜索：`start_search`（支持文件名和内容搜索，流式返回结果）
  - 进程管理：`start_process`、`interact_with_process`（交互式REPL）
  - 数据分析：支持Python/Node.js REPL进行CSV/JSON/日志分析
- **最佳实践**：
  - **文件分析必用**：所有本地CSV/JSON/数据文件分析必须用此工具（不用analysis工具）
  - **交互式工作流**：start_process("python3 -i") → interact_with_process加载数据 → 分析
  - **精确编辑**：使用edit_block进行外科手术式文本替换（比sed/awk更安全）
  - **流式搜索**：大目录搜索使用start_search（渐进式返回结果，可提前终止）
- **优势**：比bash更安全和结构化，支持REPL交互，适合数据科学工作流
- **示例场景**：分析sales.csv、处理config.json、搜索代码模式、管理后台进程
- **注意事项**：
  - 绝对优先于bash cat/grep/find等命令
  - 本地文件分析禁止使用analysis/REPL工具（会失败）
  - 使用绝对路径以保证可靠性

#### 编程文档检索优先级（context7 优先）

**context7 - 编程库/SDK/API 文档**（最高优先级）：
- **触发条件**：任何关于编程库、框架、SDK、API 的问题
- **调用方式**：
  1. 首先调用 `resolve-library-id` 获取 Context7 兼容的库 ID
  2. 然后调用 `get-library-docs` 获取文档（可选 topic 参数聚焦）
- **优势**：专门优化编程上下文，token 高效，最新官方文档
- **示例场景**：React hooks 用法、Next.js 路由、MongoDB 查询语法
- **注意事项**：必须先 resolve-library-id，除非用户明确提供 `/org/project` 格式的库 ID

**firecrawl - 通用网页检索**（通用后备）：
- **触发条件**：context7 无法满足、需要最新博客/文章/教程
- **调用方式**：
  1. `firecrawl_search`：搜索并抓取内容（推荐，自动返回内容）
  2. `firecrawl_scrape`：单页抓取（已知 URL 时）
  3. `firecrawl_map`：网站结构发现（探索网站时）
- **优势**：强大抓取能力、支持多种模式、处理复杂网页
- **示例场景**：最新技术趋势、社区最佳实践、问题排查博客
- **注意事项**：优先使用 search（带 scrapeOptions），避免过度抓取

#### GitHub 项目协作集成

**github - 完整 GitHub 操作**：
- **核心能力**：
  - 代码搜索：`search_code`、`search_repositories`
  - PR 管理：`create_pull_request`、`get_pull_request`、`merge_pull_request`
  - Issue 管理：`create_issue`、`update_issue`、`list_issues`
  - 代码审查：`create_and_submit_pull_request_review`
  - 文件操作：`create_or_update_file`、`push_files`
- **触发条件**：需要操作 GitHub 仓库、搜索开源代码、管理协作流程
- **最佳实践**：
  - 搜索代码时使用 `search_code`（比 firecrawl 更精准）
  - 创建 PR 前先调用 `get_pull_request_dif