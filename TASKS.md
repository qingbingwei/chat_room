# TASKS – 基于服务器转发的多客户端数据共享与交换系统

> 后端：Go（Socket 编程，TCP 或 UDP 其一即可，推荐 TCP）  
> 前端：Vue 3 + Element Plus  
> 通信：自定义应用层协议，文本 / 图片 / 文件均需支持，一对一与组通信

---

## 1. 系统总体目标

1. 实现一个基于 Socket 的多客户端通信系统，所有消息通过中心服务器转发。
2. 支持多种数据类型的共享与交换：文字消息、图片、任意文件。
3. 服务器维护在线用户列表，客户端可以获取并定时/实时刷新。
4. 支持：
   - 一对一通信：从在线列表中选择一个用户私聊。
   - 组通信：从在线列表中选择多个用户（至少 2 个）进行组消息通信。
5. 提供清晰的应用层协议设计文档，并在代码中严格实现。
6. 提供可视化界面（Vue3 + Element Plus），完成基础聊天及文件发送操作界面。

---

## 2. 技术选型与基础结构

### 2.1 后端（Server, Go）

- 语言：Go 1.20+（可根据实际环境调整）
- 通信方式：基于 `net` 包的 Socket 编程
  - 推荐：TCP 长连接（易于维护连接状态和在线用户列表）
  - 可选：UDP（若选用则需自行实现可靠传输机制，优先完成 TCP 版本）
- 并发模型：Goroutine + Channel（或其他并发机制）
- 数据序列化格式：
  - 推荐：JSON（简单易调试）
  - 若有性能需求，可扩展为 Protobuf 等

### 2.2 前端（Client UI）

- 框架：Vue 3 + Vite
- UI 组件库：Element Plus
- 通信方式：
  - 若直接使用 TCP/UDP：需要在 Electron 或 Node 侧实现，再通过 Web 通信到前端（复杂度高）
  - 若采用 WebSocket 作“桥接层”（在 Go 服务器内部仍可使用 TCP 作为业务层）：前端通过 WebSocket 连接服务器
- 本任务文档默认后端对外提供 WebSocket 接口（内部可以按要求使用 TCP/UDP 实现业务逻辑）

> 注：如果课程/作业要求“前端也必须基于原生 Socket（TCP/UDP）”，请在任务分解中新增一层桌面客户端或本地代理进程，这里不展开。

---

## 3. 应用层协议设计任务

### 3.1 抽象消息格式定义

- 任务：定义统一的消息结构，确保能够支持文本、图片、文件以及各种控制消息。
- 建议设计（JSON 示意）：

```json
{
  "type": "message|file|system|heartbeat|auth|userlist",
  "sub_type": "text|image|binary|login|logout|...",
  "from": "user_id",
  "to": ["user_id1", "user_id2"],
  "group_id": "optional-group-id",
  "timestamp": 1732435200000,
  "payload": {
    "text": "hello",
    "file_name": "pic.png",
    "file_size": 12345,
    "file_chunk_index": 0,
    "file_chunk_total": 10,
    "file_data_base64": "...."
  }
}
```

#### 子任务

1. [ ] 明确定义消息顶层字段：
   - `type`：消息大类（例如：`auth`、`message`、`file`、`system`、`userlist`、`heartbeat`）
   - `sub_type`：细分类型（例如：`text`、`image`、`binary`、`login`、`logout` 等）
   - `from` / `to`：发送者 / 接收者列表
   - `group_id`：用于组通信的标识（可选）
   - `timestamp`：时间戳（毫秒）
   - `payload`：实际业务数据
2. [ ] 定义文字消息协议（`type=message`, `sub_type=text`）
3. [ ] 定义图片消息协议（`type=message`, `sub_type=image`）
   - 图片传输采用：Base64 / 文件消息方式（二选一，建议统一为文件消息协议）
4. [ ] 定义文件消息协议（`type=file`）
   - 支持大文件分片：
     - `file_name` / `file_size`
     - `file_chunk_index` / `file_chunk_total`
     - `file_data_base64`（或二进制）
5. [ ] 定义用户状态与在线列表协议：
   - 登录请求 / 响应（`type=auth`, `sub_type=login`）
   - 登出通知（`type=system`, `sub_type=logout`）
   - 在线用户列表下发（`type=userlist`）
6. [ ] 心跳/保活协议（`type=heartbeat`）以维持长连接并检测断线。
7. [ ] 协议文档撰写：
   - [ ] 在文档中罗列所有消息类型、字段意义、示例 JSON
   - [ ] 说明服务器转发规则（点对点 / 组广播）

---

## 4. 后端开发任务（Go）

### 4.1 基础结构与项目骨架

1. [ ] 初始化 Go 项目结构：
   - `/cmd/server/main.go`：入口
   - `/internal/server/`：核心服务逻辑
   - `/internal/protocol/`：协议相关结构体与编码/解码函数
   - `/internal/clients/`：客户端连接管理
   - `/internal/rooms/`：组通信/房间管理（可选）
2. [ ] 在 `main.go` 中：
   - [ ] 读取配置（端口、协议类型 TCP/UDP 等）
   - [ ] 启动监听（`net.Listen("tcp", addr)` 或 UDP）
   - [ ] 接受连接并为每个连接启动 goroutine 处理

### 4.2 客户端连接与在线用户管理

1. [ ] 设计 `Client` 结构：
   - 连接对象（TCP Conn / WebSocket Conn）
   - 用户 ID / 昵称
   - 发送队列（chan）
   - 状态（在线/离线）
2. [ ] 维护全局在线用户表：
   - map[userID]*Client  
   - 提供线程安全访问（`sync.RWMutex`）
3. [ ] 登录流程：
   - [ ] 客户端发送 `auth.login` 消息（携带用户名/密码或仅昵称）
   - [ ] 服务器验证/注册（简单实现：只要用户名唯一即认为登录成功）
   - [ ] 返回登录结果，包含分配的 user_id
   - [ ] 更新在线用户列表，并广播给所有在线客户端（`type=userlist`）
4. [ ] 登出 / 断开连接处理：
   - [ ] 监听客户端断开事件
   - [ ] 从在线列表移除
   - [ ] 广播更新后的在线用户列表

### 4.3 消息分发与路由

1. [ ] 实现消息接收循环：
   - [ ] 针对每个连接读取数据
   - [ ] 按协议进行解包 / 反序列化
   - [ ] 根据 `type` / `sub_type` 分发到对应处理逻辑
2. [ ] 一对一消息转发：
   - [ ] `type=message`, `to` 中只有 1 个 user_id
   - [ ] 服务端查找对应的 `Client`，将消息推送到其发送队列
3. [ ] 组通信消息转发：
   - [ ] `type=message`, `to` 中包含多个 user_id
   - [ ] 依次向 `to` 列表中的在线用户转发
   - [ ] 可选：增加 `group_id` 概念，由服务器维护组成员列表，实现简化转发
4. [ ] 消息持久化（可选拓展）：
   - 本任务中可仅做内存转发，不做持久化

### 4.4 文件与图片传输

1. [ ] 设计文件分片上传处理：
   - [ ] 服务端接收 `type=file` 消息
   - [ ] 通过 `file_chunk_index` / `file_chunk_total` 识别是否接收完成
   - 简化方案（推荐）：
     - 服务器不做落盘重组，仅将分片原样转发给目标客户端（客户端完成重组）
2. [ ] 大小限制与安全控制：
   - [ ] 在服务器侧限制单次消息大小、文件大小（如 >100MB 拒绝）
   - [ ] 对异常或恶意客户端进行断链处理

### 4.5 在线用户列表推送

1. [ ] 在线用户列表数据结构：
   - `[]UserInfo`，`UserInfo` 包含 user_id, nickname, login_time 等
2. [ ] 触发条件：
   - [ ] 用户登录成功
   - [ ] 用户注销/连接断开
3. [ ] 推送协议：
   - `type=userlist`，payload 中放置 `users` 数组
4. [ ] 客户端拉取 + 推送结合：
   - 客户端首次登录后可主动请求一次用户列表
   - 后续通过服务端广播保持更新

### 4.6 心跳与超时机制

1. [ ] 客户端定期发送 `type=heartbeat` 消息
2. [ ] 服务器维护最近心跳时间
3. [ ] 超时未收到心跳则认为断线，关闭连接并更新在线列表

---

## 5. 前端开发任务（Vue3 + Element Plus）

### 5.1 项目初始化与基本布局

1. [ ] 使用 Vite 创建 Vue3 项目
2. [ ] 引入 Element Plus（按需或全量）
3. [ ] 页面结构：
   - 登录页 / 弹窗：输入昵称或账号信息
   - 主界面布局：
     - 左侧：在线用户列表
     - 中间：消息显示区域（对话内容）
     - 右侧（可选）：文件列表 / 图片预览
     - 底部：消息输入框 + 发送按钮 + 文件选择按钮

### 5.2 与服务器建立连接

1. [ ] 使用 WebSocket 连接后端（或其他 Socket 方案）：
   - [ ] 封装一个 `socketService`，负责：
     - 连接 / 重连
     - 发送 JSON 消息
     - 监听消息并分发到应用状态
2. [ ] 登录流程：
   - [ ] 在前端发送 `auth.login` 消息
   - [ ] 收到成功响应后进入主界面，保存 user_id

### 5.3 在线用户列表展示与刷新

1. [ ] 显示在线用户列表（Element Plus 的 `ElTable` 或 `ElTree`）
2. [ ] 收到 `type=userlist` 消息时更新列表
3. [ ] 支持选中用户：
   - 单选：一对一通信
   - 多选：组通信（限制至少 2 人）

### 5.4 消息发送与展示

1. [ ] 文本消息：
   - [ ] 输入框 + 发送按钮
   - [ ] 通过 Socket 发送 `type=message`, `sub_type=text`, `to=[...]`
2. [ ] 图片 / 文件消息：
   - [ ] 使用 `ElUpload` 或自定义文件选择组件
   - [ ] 读取文件并按协议封装为 `type=file` 消息
3. [ ] 消息展示：
   - [ ] 按时间顺序在中间区域显示
   - [ ] 区分自己与他人消息（对齐方式/颜色）
   - [ ] 对图片消息进行预览渲染
   - [ ] 文件提供下载（Blob URL）/ 打开链接

### 5.5 组通信界面交互

1. [ ] 支持从在线列表中多选用户后创建“临时会话”
2. [ ] 在对话窗口顶部显示参与用户列表
3. [ ] 所有在该会话中发送的消息都带 `to` 为这些用户 ID

---

## 6. 系统功能与关系展示任务

1. [ ] 绘制系统架构图（可在文档中使用 UML 或简图）：
   - 客户端（浏览器） ←→ WebSocket 网关（Go） ←→ 内部 TCP/UDP 通信层 ←→ 其他客户端
   - 展示服务器如何转发一对一消息和组消息
2. [ ] 绘制主要模块关系图：
   - 连接管理模块
   - 消息路由模块
   - 协议编码/解码模块
   - 前端 UI 模块划分（登录 / 用户列表 / 聊天窗口 / 文件发送）
3. [ ] 在 README 或设计文档中简单说明：  
   - 消息流转过程（从客户端 A 到客户端 B 的完整路径）
   - 用户上下线事件的处理流程

---

## 7. 测试任务

1. [ ] 单元测试（后端）：
   - 协议编码/解码函数
   - 用户管理（登录/登出/在线列表更新）
2. [ ] 手工测试场景：
   - [ ] 启动服务器，启动多个客户端
   - [ ] 用户 A/B/C 登录，客户端在线列表自动刷新
   - [ ] A 与 B 一对一发消息，双方均能正常收发
   - [ ] A 选择 B/C 进行组通信，B/C 均能收到同一条消息
   - [ ] 发送文本 / 图片 / 文件，接收端正常展示/下载
   - [ ] 断开一个客户端，其他客户端自动刷新在线列表

---

## 8. 文档与提交内容要求

1. [ ] `TASKS.md`（本文件）：任务分解文档
2. [ ] `PROTOCOL.md`：详细应用协议设计说明
3. [ ] `README.md`：项目说明、运行方式、演示说明
4. [ ] 关键界面截图（登录、在线列表、一对一聊天、组聊天、文件传输）可附在 README 中

---

## 9. 可选扩展任务（非必做）

- [ ] 支持简单的用户注册 / 密码登录与鉴权
- [ ] 支持群组持久化（创建群、加入/退出群）
- [ ] 支持消息历史记录与离线消息
- [ ] 支持消息搜索
- [ ] 支持加密传输（TLS）

---